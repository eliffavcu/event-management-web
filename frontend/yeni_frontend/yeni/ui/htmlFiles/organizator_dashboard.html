<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Organizator Dashboard - EventSphere</title>
  <meta content="Manage your EventSphere organizer account" name="description">
  <meta content="organizer, profile, events, dashboard" name="keywords">

  <!-- Favicons -->
  <link href="/assets/img/favicon.png" rel="icon">
  <link href="/assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Poppins:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,600;0,700;1,300;1,400;1,600;1,700&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="/assets/vendor/aos/aos.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="/assets/css/main.css" rel="stylesheet">
  <link href="/assets/css/custom.css" rel="stylesheet">

  <style>
    .dashboard-section {
      background: url("/assets/img/dashboardBackground.jpg") center center;
      background-size: cover;
      background-attachment: fixed;
      padding: 120px 0 60px;
      min-height: calc(100vh - 72px);
      position: relative;
    }

    .dashboard-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 1;
    }

    .profile-card {
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin-bottom: 30px;
      background-color: rgba(255, 255, 255, 0.9);
    }

    .profile-header {
      background-color: var(--primary-color);
      color: white;
      padding: 30px;
      position: relative;
    }

    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: white;
      padding: 5px;
      margin-bottom: 20px;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .profile-name {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .profile-email {
      font-size: 16px;
      opacity: 0.9;
    }

    .profile-body {
      padding: 30px;
      background: white;
    }

    .info-item {
      margin-bottom: 20px;
    }

    .info-label {
      font-weight: 600;
      color: var(--secondary-color);
      margin-bottom: 5px;
    }

    .info-value {
      color: #6c757d;
    }

    .dashboard-title {
      color: white;
      margin-bottom: 30px;
      font-weight: 700;
    }

    .event-item {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .event-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .event-info {
      font-size: 14px;
      color: #555;
      margin-bottom: 5px;
    }

    .event-info i {
      color: var(--primary-color);
      margin-right: 5px;
    }

    .create-event-section {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      padding: 30px;
      margin-top: 30px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .create-event-section h3 {
      margin-bottom: 20px;
      color: var(--primary-color);
    }

    .form-label {
      font-weight: 600;
      color: var(--secondary-color);
    }

    .form-control,
    .form-select {
      border-radius: 5px;
      border: 1px solid #ced4da;
    }

    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-primary:hover {
      background-color: var(--primary-color-dark);
      border-color: var(--primary-color-dark);
    }

    .update-event-section {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      padding: 30px;
      margin-top: 30px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .update-event-section h3 {
      margin-bottom: 20px;
      color: var(--primary-color);
    }
  </style>
</head>

<body>
  <!-- ======= Header ======= -->
  <header id="header" class="header fixed-top d-flex align-items-center">
    <div class="container-fluid d-flex align-items-center justify-content-between">
      <a href="/" class="logo d-flex align-items-center me-auto me-xl-0">
        <h1>EventSphere</h1>
        <span>.</span>
      </a>

      <!-- Nav Menu -->
      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="/#symposium">Symposium</a></li>
          <li><a href="/#festival">Festival</a></li>
          <li><a href="/#workshop">Workshop</a></li>
          <li><a href="/#conference">Conference</a></li>
          <li><a href="/#seminar">Seminar</a></li>
          <li><a href="/#concert">Concert</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>

      <!-- Account Dropdown -->
      <div class="dropdown account-dropdown">
        <button class="btn btn-account dropdown-toggle" type="button" id="accountDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-person-circle me-1"></i>
          <span id="user-name">Your Account</span>
        </button>
        <ul class="dropdown-menu" aria-labelledby="accountDropdown">
          <li><a class="dropdown-item active" href="/htmlFiles/organizator_dashboard.html">My Account</a></li>
          <li><a class="dropdown-item" href="#" id="logout-button">Logout</a></li>
        </ul>
      </div>
    </div>
  </header><!-- End Header -->

  <!-- ======= Dashboard Section ======= -->
  <section class="dashboard-section">
    <div class="container">
      <h2 class="dashboard-title text-center">Organizator Dashboard</h2>

      <div class="row">
        <!-- Profile Info Card -->
        <div class="col-lg-4">
          <div class="profile-card">
            <div class="profile-header">
              <div class="profile-avatar">
                <img src="https://source.unsplash.com/featured/?business" alt="Profile" id="profile-image">
              </div>
              <h2 class="profile-name" id="profile-name">Loading...</h2>
              <p class="profile-email" id="profile-email">Loading...</p>
            </div>
            <div class="profile-body">
              <div class="info-item">
                <div class="info-label">Name</div>
                <div class="info-value" id="profile-fullname">Loading...</div>
              </div>
              <div class="info-item">
                <div class="info-label">Telephone</div>
                <div class="info-value" id="profile-telephone">Loading...</div>
              </div>
              <div class="info-item">
                <div class="info-label">Email</div>
                <div class="info-value" id="profile-email-info">Loading...</div>
              </div>
              <div class="info-item">
                <div class="info-label">Location</div>
                <div class="info-value" id="profile-location">Loading...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Organizer Events Section -->
        <div class="col-lg-8">
          <div class="events-section">
            <h3 class="text-white mb-4">My Events</h3>
            <div id="events-container"></div>
            <div id="no-events" class="text-white" style="display: none;">No events found for your account.</div>
          </div>
        </div>
      </div>
    </div>
  </section><!-- End Dashboard Section -->

  <!-- ======= Manage Events Section ======= -->
  <section id="manage-events-section" class="manage-events-section mt-5">
    <div class="container">
      <button class="btn btn-primary w-100 mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#event-management-collapse" aria-expanded="false" aria-controls="event-management-collapse">
        Manage Events (Create/Update)
      </button>
      <div class="collapse" id="event-management-collapse">
        <!-- Create Event Section -->
        <section id="create-event-section" class="create-event-section mt-3">
          <h3>Create a New Event</h3>
          <form id="create-event-form">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="event-name" class="form-label">Event Name</label>
                <input type="text" class="form-control" id="event-name" placeholder="Enter event name" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="event-location" class="form-label">Event Location</label>
                <input type="text" class="form-control" id="event-location" placeholder="Enter event location" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="event-date" class="form-label">Event Date</label>
                <input type="date" class="form-control" id="event-date" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="event-time" class="form-label">Event Time</label>
                <input type="time" class="form-control" id="event-time" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="event-type" class="form-label">Event Type</label>
                <select class="form-select" id="event-type" required>
                  <option value="1">Symposium</option>
                  <option value="2">Festival</option>
                  <option value="3">Workshop</option>
                  <option value="4">Conference</option>
                  <option value="5">Seminar</option>
                  <option value="6">Concert</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="event-capacity" class="form-label">Limit for Attendance</label>
                <input type="number" class="form-control" id="event-capacity" placeholder="Enter attendance limit" required>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Create Event</button>
          </form>
        </section>

        <!-- Update Event Section -->
        <section id="update-event-section" class="update-event-section mt-5">
          <h3>Update Event</h3>
          <form id="update-event-form">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="update-event-id" class="form-label">Event ID</label>
                <input type="text" class="form-control" id="update-event-id" placeholder="Enter event ID" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="update-event-name" class="form-label">Event Name</label>
                <input type="text" class="form-control" id="update-event-name" placeholder="Enter event name" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="update-event-location" class="form-label">Event Location</label>
                <input type="text" class="form-control" id="update-event-location" placeholder="Enter event location" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="update-event-date" class="form-label">Event Date</label>
                <input type="date" class="form-control" id="update-event-date" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="update-event-time" class="form-label">Event Time</label>
                <input type="time" class="form-control" id="update-event-time" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="update-event-type" class="form-label">Event Type</label>
                <select class="form-select" id="update-event-type" required>
                  <option value="1">Symposium</option>
                  <option value="2">Festival</option>
                  <option value="3">Workshop</option>
                  <option value="4">Conference</option>
                  <option value="5">Seminar</option>
                  <option value="6">Concert</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="update-event-capacity" class="form-label">Limit for Attendance</label>
                <input type="number" class="form-control" id="update-event-capacity" placeholder="Enter attendance limit" required>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Update Event</button>
          </form>
        </section>
      </div>
    </div>
  </section><!-- End Manage Events Section -->

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/vendor/aos/aos.js"></script>

  <!-- Main JS File -->
  <script src="/assets/js/main.js"></script>

  <!-- Dashboard JS -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const isLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
      const userType = localStorage.getItem('userType');
      const organizatorId = localStorage.getItem('userId'); // Retrieve organizatorId from localStorage

      if (!isLoggedIn || userType !== 'organizator' || !organizatorId) {
        window.location.href = '/htmlFiles/login.html';
      }

      // Load organizer profile data
      loadOrganizerProfile(organizatorId);

      // Load organizer's events
      loadOrganizerEvents(organizatorId);

      // Logout functionality
      document.getElementById('logout-button').addEventListener('click', function (e) {
        e.preventDefault();
        localStorage.clear();
        window.location.href = '/';
      });
    });

    function loadOrganizerProfile(organizatorId) {
      const apiUrl = `http://localhost:5000/api/organizators/${organizatorId}?action=get`;

      fetch(apiUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(apiResponse => {
          if (apiResponse.status === "success") {
            const organizatorData = apiResponse.data;
            updateProfileUI(organizatorData);
          } else {
            console.error("Failed to load organizer profile:", apiResponse.message);
          }
        })
        .catch(error => {
          console.error("Error fetching organizer profile:", error);
          alert("An error occurred while fetching organizer profile. Please try again later.");
        });
    }

    function loadOrganizerEvents(organizatorId) {
      const apiUrl = `http://localhost:5000/api/events?action=list`;

      fetch(apiUrl)
        .then(response => response.json())
        .then(apiResponse => {
          if (apiResponse.status === "success") {
            const events = apiResponse.data;
            const organizerEvents = events.filter(event => event.organizator_id == organizatorId);
            updateOrganizerEventsUI(organizerEvents);
          } else {
            console.error("Failed to load events:", apiResponse.message);
          }
        })
        .catch(error => {
          console.error("Error fetching events:", error);
          alert("An error occurred while fetching events. Please try again later.");
        });
    }

    function updateOrganizerEventsUI(events) {
      const eventsContainer = document.getElementById('events-container');
      const noEventsElement = document.getElementById('no-events');

      if (events && events.length > 0) {
        noEventsElement.style.display = 'none';
        events.forEach(event => {
          const eventItem = `
          <div class="event-item" id="event-${event.event_id}">
            <h4 class="event-title">${event.event_name}</h4>
            <div class="event-info">
              <i class="bi bi-hash"></i>
              <span>Event ID: ${event.event_id}</span>
            </div>
            <div class="event-info">
              <i class="bi bi-calendar"></i>
              <span>Date: ${new Date(event.event_date).toLocaleDateString()}</span>
            </div>
            <div class="event-info">
              <i class="bi bi-clock"></i>
              <span>Time: ${event.event_time}</span>
            </div>
            <div class="event-info">
              <i class="bi bi-geo-alt"></i>
              <span>Location: ${event.event_location}</span>
            </div>
            <div class="event-info">
              <i class="bi bi-people"></i>
              <span>Capacity: ${event.limit_for_attendance}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
              <a href="/htmlFiles/event_details.html?event_id=${event.event_id}" class="btn btn-primary btn-sm">View Event</a>
              <button class="btn btn-info btn-sm" onclick="viewParticipants(${event.event_id})">View Participants</button>
              <button class="btn btn-danger btn-sm" onclick="deleteEvent(${event.event_id})">Delete</button>
            </div>
            <div class="participants-list mt-3 d-none" id="participants-${event.event_id}">
              <h5>Participants</h5>
              <ul class="list-group"></ul>
            </div>
          </div>
        `;
          eventsContainer.insertAdjacentHTML('beforeend', eventItem);
        });
      } else {
        noEventsElement.style.display = 'block';
      }
    }

    function viewParticipants(eventId) {
      const apiUrl = `http://localhost:5000/api/attendances?action=list`;

      fetch(apiUrl)
        .then(response => response.json())
        .then(apiResponse => {
          if (apiResponse.status === "success") {
            const attendances = apiResponse.data;
            const eventParticipants = attendances.filter(attendance => attendance.event_id === eventId);

            const participantsList = document.getElementById(`participants-${eventId}`);
            const participantsContainer = participantsList.querySelector('.list-group');
            participantsContainer.innerHTML = ''; // Clear previous participants

            if (eventParticipants.length > 0) {
              eventParticipants.forEach(participant => {
                const participantItem = `
                  <li class="list-group-item">
                    <strong>${participant.user_name} ${participant.user_surname}</strong>
                    <span class="text-muted"> (User ID: ${participant.user_id})</span>
                  </li>
                `;
                participantsContainer.insertAdjacentHTML('beforeend', participantItem);
              });
            } else {
              participantsContainer.innerHTML = '<li class="list-group-item text-muted">No participants for this event.</li>';
            }

            participantsList.classList.remove('d-none'); // Show participants list
          } else {
            alert(apiResponse.message || "Failed to load participants. Please try again.");
          }
        })
        .catch(error => {
          console.error("Error fetching participants:", error);
          alert("An error occurred while fetching participants. Please try again.");
        });
    }

    function deleteEvent(eventId) {
      const apiUrl = `http://localhost:5000/api/events/${eventId}?action=delete`;

      if (confirm("Are you sure you want to delete this event?")) {
        fetch(apiUrl)
          .then(response => response.json())
          .then(apiResponse => {
            if (apiResponse.status === "success") {
              alert(apiResponse.message);
              document.getElementById(`event-${eventId}`).remove();

              // Check if there are no more events and show the "No events" message
              const eventsContainer = document.getElementById('events-container');
              if (!eventsContainer.querySelector('.event-item')) {
                document.getElementById('no-events').style.display = 'block';
              }
            } else {
              alert(apiResponse.message || "Failed to delete event. Please try again.");
            }
          })
          .catch(error => {
            console.error("Error deleting event:", error);
            alert("An error occurred while deleting the event. Please try again.");
          });
      }
    }

    function updateProfileUI(organizator) {
      document.getElementById('profile-name').textContent = `${organizator.organizator_name} ${organizator.organizator_surname}`;
      document.getElementById('profile-email').textContent = organizator.organizator_email;
      document.getElementById('profile-fullname').textContent = `${organizator.organizator_name} ${organizator.organizator_surname}`;
      document.getElementById('profile-telephone').textContent = organizator.organizator_telephone;
      document.getElementById('profile-email-info').textContent = organizator.organizator_email;
      document.getElementById('profile-location').textContent = organizator.organization_location;
    }

    // Event creation functionality
    document.addEventListener('DOMContentLoaded', function () {
      const organizatorId = localStorage.getItem('userId'); // Retrieve organizer ID from localStorage

      if (!organizatorId) {
        alert("You must be logged in as an organizer to create events.");
        window.location.href = '/htmlFiles/login.html';
        return;
      }

      // Handle event creation form submission
      const createEventForm = document.getElementById('create-event-form');
      createEventForm.addEventListener('submit', function (e) {
        e.preventDefault();

        const eventName = document.getElementById('event-name').value;
        const eventLocation = document.getElementById('event-location').value;
        const eventDate = document.getElementById('event-date').value;
        const eventTime = document.getElementById('event-time').value;
        const eventTypeId = document.getElementById('event-type').value;
        const eventCapacity = document.getElementById('event-capacity').value;

        const apiUrl = `http://localhost:5000/api/events?action=create&event_name=${encodeURIComponent(eventName)}&event_location=${encodeURIComponent(eventLocation)}&event_date=${eventDate}&event_time=${eventTime}&event_type_id=${eventTypeId}&limit_for_attendance=${eventCapacity}&organizator_id=${organizatorId}`;

        fetch(apiUrl)
          .then(response => response.json())
          .then(apiResponse => {
            if (apiResponse.status === "success") {
              alert(apiResponse.message);
              // Optionally reload the organizer's events
              loadOrganizerEvents(organizatorId);
            } else {
              alert(apiResponse.message || "Failed to create event. Please try again.");
            }
          })
          .catch(error => {
            console.error("Error creating event:", error);
            alert("An error occurred while creating the event. Please try again.");
          });
      });
    });

    // Event update functionality
    document.addEventListener('DOMContentLoaded', function () {
      const organizatorId = localStorage.getItem('userId'); // Retrieve organizer ID from localStorage

      if (!organizatorId) {
        alert("You must be logged in as an organizer to update events.");
        window.location.href = '/htmlFiles/login.html';
        return;
      }

      // Handle event update form submission
      const updateEventForm = document.getElementById('update-event-form');
      updateEventForm.addEventListener('submit', function (e) {
        e.preventDefault();

        const eventId = document.getElementById('update-event-id').value;
        const eventName = document.getElementById('update-event-name').value;
        const eventLocation = document.getElementById('update-event-location').value;
        const eventDate = document.getElementById('update-event-date').value;
        const eventTime = document.getElementById('update-event-time').value;
        const eventTypeId = document.getElementById('update-event-type').value;
        const eventCapacity = document.getElementById('update-event-capacity').value;

        const apiUrl = `http://localhost:5000/api/events/${eventId}?action=update&event_name=${encodeURIComponent(eventName)}&event_location=${encodeURIComponent(eventLocation)}&event_date=${eventDate}&event_time=${eventTime}&event_type_id=${eventTypeId}&limit_for_attendance=${eventCapacity}&organizator_id=${organizatorId}`;

        fetch(apiUrl)
          .then(response => response.json())
          .then(apiResponse => {
            if (apiResponse.status === "success") {
              alert(apiResponse.message);
              // Optionally reload the organizer's events
              loadOrganizerEvents(organizatorId);
            } else {
              alert(apiResponse.message || "Failed to update event. Please try again.");
            }
          })
          .catch(error => {
            console.error("Error updating event:", error);
            alert("An error occurred while updating the event. Please try again.");
          });
      });
    });
  </script>
</body>

</html>
