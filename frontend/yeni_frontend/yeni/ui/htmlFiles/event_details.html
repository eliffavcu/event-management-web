<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Event Details - EventSphere</title>
  <meta content="Event details and registration" name="description">
  <meta content="event, details, registration, EventSphere" name="keywords">

  <!-- Favicons -->
  <link href="https://via.placeholder.com/32" rel="icon">
  <link href="https://via.placeholder.com/180" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Poppins:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,600;0,700;1,300;1,400;1,600;1,700&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/glightbox/3.0.9/css/glightbox.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/9.0.5/swiper-bundle.min.css" rel="stylesheet">

  <!-- Main CSS Files -->
  <link href="/assets/css/main.css" rel="stylesheet">
  <link href="/assets/css/custom.css" rel="stylesheet">

  <style>
    .event-hero {
      height: 50vh;
      background-size: cover;
      background-position: center;
      position: relative;
      display: flex;
      align-items: flex-end;
      margin-top: 72px;
    }
    
    .event-hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.7));
      z-index: 0;
    }
    
    .event-hero-content {
      position: relative;
      z-index: 1;
      width: 100%;
      padding: 30px 0;
      color: #fff;
    }
    
    .event-hero h1 {
      font-size: 42px;
      font-weight: 700;
      margin-bottom: 15px;
      color: #fff;
    }
    
    .event-hero .event-badges {
      margin-bottom: 15px;
    }
    
    .event-hero .badge {
      font-size: 14px;
      padding: 8px 15px;
      margin-right: 10px;
      background: var(--primary-color);
    }

    .event-details {
      padding: 60px 0;
    }
    
    .event-details .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.08);
      margin-bottom: 30px;
      overflow: hidden;
    }
    
    .event-details .card-title {
      color: var(--secondary-color);
      font-weight: 600;
      font-size: 24px;
      margin-bottom: 20px;
    }
    
    .event-details .info-item {
      display: flex;
      align-items: flex-start;
      margin-bottom: 20px;
    }
    
    .event-details .info-item i {
      font-size: 24px;
      color: var(--primary-color);
      margin-right: 15px;
      margin-top: 2px;
    }
    
    .event-details .info-item h6 {
      font-weight: 600;
      margin: 0;
      color: var(--secondary-color);
    }
    
    .event-details .info-item p {
      margin: 5px 0 0 0;
      color: #6c757d;
    }
    
    .event-details .card-body {
      padding: 30px;
    }
    
    .event-details .event-description {
      margin-bottom: 30px;
      line-height: 1.7;
    }
    
    .event-image-gallery {
      margin-bottom: 30px;
    }
    
    .event-image-gallery img {
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .register-btn {
      padding: 12px 25px;
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 50px;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s ease;
      display: inline-block;
      text-decoration: none;
      text-align: center;
    }
    
    .register-btn:hover {
      background: #0c8da0;
      transform: translateY(-3px);
      color: #fff;
    }
    
    .organizer-info {
      display: flex;
      align-items: center;
      margin-top: 20px;
    }
    
    .organizer-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      overflow: hidden;
      margin-right: 15px;
    }
    
    .organizer-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .organizer-details h6 {
      margin: 0;
      font-weight: 600;
    }
    
    .organizer-details p {
      margin: 0;
      color: #6c757d;
      font-size: 14px;
    }
    
    .event-capacity-indicator {
      margin-top: 30px;
    }
    
    .capacity-bar {
      height: 10px;
      background-color: #e9ecef;
      border-radius: 5px;
      margin-bottom: 10px;
      overflow: hidden;
    }
    
    .capacity-fill {
      height: 100%;
      background-color: var(--primary-color);
      border-radius: 5px;
      transition: width 0.5s ease;
    }
    
    .capacity-text {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #6c757d;
    }
    
    .event-map {
      height: 250px;
      border-radius: 10px;
      overflow: hidden;
    }
    
    /* Home link */
    .home-link {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 10;
    }
    
    .home-link a {
      color: white;
      font-size: 16px;
      text-decoration: none;
      display: flex;
      align-items: center;
    }
    
    .home-link i {
      margin-right: 5px;
      font-size: 18px;
    }
    
    @media (max-width: 768px) {
      .event-hero h1 {
        font-size: 32px;
      }
      
      .event-hero {
        height: 40vh;
      }
      
      .event-details .card-body {
        padding: 20px;
      }
    }
  </style>
</head>

<body>
  <!-- ======= Header ======= -->
  <header id="header" class="header fixed-top d-flex align-items-center">
    <div class="container-fluid d-flex align-items-center justify-content-between">
      <a href="/" class="logo d-flex align-items-center me-auto me-xl-0">
        <h1>EventSphere</h1>
        <span>.</span>
      </a>

      <!-- Nav Menu -->
      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="/#symposium">Symposium</a></li>
          <li><a href="/#festival">Festival</a></li>
          <li><a href="/#workshop">Workshop</a></li>
          <li><a href="/#conference">Conference</a></li>
          <li><a href="/#seminar">Seminar</a></li>
          <li><a href="/#concert">Concert</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>

      <div class="header-buttons d-flex align-items-center">
        <a href="/login.html" class="btn-login">Login</a>
        <a href="/register.html" class="btn-register ms-3">Register</a>
      </div>
    </div>
  </header><!-- End Header -->

  <!-- ======= Event Hero Section ======= -->
  <section id="event-hero" class="event-hero">
    <div class="container event-hero-content">
      <div class="row">
        <div class="col-lg-8">
          <div class="event-badges">
            <span class="badge" id="event-category">Category Loading...</span>
            <span class="badge bg-success" id="event-status">Status Loading...</span>
          </div>
          <h1 id="event-title">Event Title Loading...</h1>
          <p id="event-short-description">Event short description loading...</p>
        </div>
      </div>
    </div>
  </section><!-- End Event Hero -->

  <!-- ======= Event Details Section ======= -->
  <section id="event-details" class="event-details">
    <div class="container">
      <div class="row">
        <div class="col-lg-8">
          <!-- Event Location Map -->
          <div class="card">
            <div class="card-body">
              <h3 class="card-title">Location</h3>
              <div class="event-map" id="event-map">
                <iframe srcdoc="" width="100%" height="100%" frameborder="0" scrolling="no" marginheight="0" marginwidth="0"></iframe>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-lg-4">
          <!-- Event Details Card -->
          <div class="card">
            <div class="card-body">
              <h3 class="card-title">Event Details</h3>
              
              <!-- Date and Time -->
              <div class="info-item">
                <i class="bi bi-calendar-event"></i>
                <div>
                  <h6>Date & Time</h6>
                  <p id="event-date">Loading date...</p>
                  <p id="event-time">Loading time...</p>
                </div>
              </div>
              
              <!-- Location -->
              <div class="info-item">
                <i class="bi bi-geo-alt"></i>
                <div>
                  <h6>Location</h6>
                  <p id="event-location">Loading location...</p>
                </div>
              </div>
              
              <!-- Speaker -->
              <div class="info-item">
                <i class="bi bi-person"></i>
                <div>
                  <h6>Speaker</h6>
                  <p id="event-speaker">Loading speaker...</p>
                </div>
              </div>
              
              <!-- Sponsor -->
              <div class="info-item">
                <i class="bi bi-briefcase"></i>
                <div>
                  <h6>Sponsor</h6>
                  <p id="event-sponsor">Loading sponsor...</p>
                </div>
              </div>
              
              <!-- Price -->
              <div class="info-item">
                <i class="bi bi-cash"></i>
                <div>
                  <h6>Price</h6>
                  <p id="event-price">Loading price...</p>
                </div>
              </div>
              
              <!-- Capacity -->
              <div class="event-capacity-indicator">
                <div class="capacity-bar">
                  <div class="capacity-fill" id="capacity-fill" style="width: 0%"></div>
                </div>
                <div class="capacity-text">
                  <span id="registered-count">0</span>
                  <span>of</span>
                  <span id="total-capacity">0</span>
                  <span>spots filled</span>
                </div>
              </div>
              
              <!-- Registration Button -->
              <a href="#" class="register-btn w-100 mt-4" id="register-button">Register for Event</a>
              
              <!-- Organizer Info -->
              <div class="organizer-info">
                <div class="organizer-avatar">
                  <img src="https://via.placeholder.com/60" alt="Organizer" id="organizer-image">
                </div>
                <div class="organizer-details">
                  <h6 id="organizer-name">Organizer Name</h6>
                  <p>Event Organizator</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section><!-- End Event Details Section -->

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- Vendor JS Files -->
  <script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/vendor/aos/aos.js"></script>
  <script src="/assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="/assets/vendor/swiper/swiper-bundle.min.js"></script>

  <!-- Main JS File -->
  <script src="/assets/js/main.js"></script>

  <!-- Event Details JS -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Get event ID from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const eventId = urlParams.get('event_id');
      
      if (!eventId) {
        showErrorMessage("No event ID provided");
        return;
      }
      
      // Load event data
      loadEventDetails(eventId);
      
      // Initialize AOS
      AOS.init({
        duration: 800,
        easing: 'ease-in-out',
        once: true,
        mirror: false
      });
      
      // Handle event attendance registration
      const registerButton = document.getElementById('register-button');
      registerButton.addEventListener('click', function (e) {
        e.preventDefault();
        const userId = localStorage.getItem('userId'); // Retrieve userId from localStorage
        
        if (!userId) {
          alert("You must be logged in to register for an event.");
          window.location.href = '/htmlFiles/login.html';
          return;
        }
        
        registerAttendance(userId, eventId);
      });
    });
    
    function loadEventDetails(eventId) {
      fetch(`http://localhost:5000/api/events/${eventId}?action=full-info`)
        .then(response => response.json())
        .then(apiResponse => {
          if (apiResponse.status === "success") {
            const event = apiResponse.data[0];
            updateEventUI(event);
          } else {
            showErrorMessage("Failed to load event details");
          }
        })
        .catch(error => {
          console.error("Error loading event details:", error);
          showErrorMessage("An error occurred while loading event details");
        });
    }
    
    function updateEventUI(event) {
      // Update hero section
      document.getElementById('event-title').textContent = event.event_name;
      document.getElementById('event-category').textContent = event.event_type_name || "Symposium"; // Use actual event type
      document.getElementById('event-status').textContent = "Upcoming";
      document.getElementById('event-short-description').textContent = `Join us for the ${event.event_name} in ${event.event_location}.`;

// Set hero background image - use allevents.jpg for all event types
const categoryImage = '/assets/img/categories/allevents.jpg';

// Set the background image
document.querySelector('.event-hero').style.backgroundImage = `url('${categoryImage}')`;

      // Update details
      document.getElementById('event-date').textContent = new Date(event.event_date).toLocaleDateString();
      document.getElementById('event-time').textContent = event.event_time || 'TBA';
      document.getElementById('event-location').textContent = event.event_location || 'TBA';
      document.getElementById('event-speaker').textContent = event.speaker_name && event.speaker_surname ? 
        `${event.speaker_name} ${event.speaker_surname}` : 'No speaker listed';
      document.getElementById('event-sponsor').textContent = event.sponsor_name && event.sponsor_surname ? 
        `${event.sponsor_name} ${event.sponsor_surname}` : 'No sponsor listed';
      document.getElementById('event-price').textContent = "Free";

      // Update map using srcdoc to avoid CORS issues
      const mapIframe = document.getElementById('event-map').querySelector('iframe');
      const encodedLocation = encodeURIComponent(event.event_location || '');
      mapIframe.srcdoc = `
        <html>
          <body style="margin:0;">
            <iframe
              src="https://maps.google.com/maps?width=100%25&height=100%25&hl=en&q=${encodedLocation}&t=&z=14&ie=UTF8&iwloc=B&output=embed"
              width="100%"
              height="100%"
              frameborder="0"
              style="border:0;"
              allowfullscreen=""
              aria-hidden="false"
              tabindex="0">
            </iframe>
          </body>
        </html>
      `;

      // Update organizer
      document.getElementById('organizer-name').textContent = event.organizator_name && event.organizator_surname ? 
        `${event.organizator_name} ${event.organizator_surname}` : 'Event Organizer';
      document.getElementById('organizer-image').src = "https://via.placeholder.com/60"; // Placeholder image
    }
    
    function showErrorMessage(message) {
      const detailsSection = document.getElementById('event-details');
      detailsSection.innerHTML = `
        <div class="container">
          <div class="alert alert-danger">
            <h4>Error</h4>
            <p>${message}</p>
            <a href="/" class="btn btn-primary mt-3">Return to Home</a>
          </div>
        </div>
      `;
    }

    function registerAttendance(userId, eventId) {
      // Fetch event details to get the event date
      fetch(`http://localhost:5000/api/events/${eventId}?action=full-info`)
        .then(response => response.json())
        .then(apiResponse => {
          if (apiResponse.status === "success") {
            const eventDate = apiResponse.data[0].event_date.split('T')[0]; // Extract only the date (YYYY-MM-DD)
            const apiUrl = `http://localhost:5000/api/attendances?action=create&user_id=${userId}&event_id=${eventId}&attending_date=${eventDate}`;

            // Send GET request to register attendance
            fetch(apiUrl)
              .then(response => response.json())
              .then(attendanceResponse => {
                if (attendanceResponse.status === "success") {
                  alert(attendanceResponse.message);
                  // Optionally, redirect to the user's dashboard or show confirmation
                  window.location.href = '/htmlFiles/user_dashboard.html';
                } else {
                  alert(attendanceResponse.message || "Failed to register attendance. Please try again.");
                }
              })
              .catch(error => {
                console.error("Error registering attendance:", error);
                alert("An error occurred while registering attendance. Please try again.");
              });
          } else {
            alert("Failed to fetch event details. Please try again.");
          }
        })
        .catch(error => {
          console.error("Error fetching event details:", error);
          alert("An error occurred while fetching event details. Please try again.");
        });
    }
  </script>
</body>

</html>